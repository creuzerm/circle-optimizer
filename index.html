<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circle Packing Optimizer</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .svg-preview svg { width: 100%; height: auto; max-height: 70vh; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Using inline SVGs to avoid React DOM conflicts with Lucide script
        const Icons = {
            Layout: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="3" x2="21" y1="9" y2="9"/><line x1="9" x2="9" y1="21" y2="9"/></svg>
            ),
            Refresh: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
            ),
            Settings: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
            ),
            Download: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
            ),
            TrendingUp: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>
            ),
            Info: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></svg>
            ),
            Layers: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>
            )
        };

        const App = () => {
            const [unit, setUnit] = useState('in');
            const [config, setConfig] = useState({
                width: 24,
                height: 12,
                diameter: 1,
                margin: 0.25,
                gap: 0.05,
                preset: '12x24',
                enableFiller: false,
                fillerDiameter: 0.5
            });

            const [results, setResults] = useState({
                total: 0,
                gridTotal: 0,
                layout: null,
                isRotated: false,
                largeCircles: [],
                fillerCircles: [],
                fillerTotal: 0
            });

            const presets = {
                imperial: {
                    '12x24': { width: 24, height: 12 },
                    '12x12': { width: 12, height: 12 },
                    '8.5x11': { width: 11, height: 8.5 },
                    '11x17': { width: 17, height: 11 },
                },
                metric: {
                    'A4': { width: 297, height: 210 },
                    'A3': { width: 420, height: 297 },
                    '500x500': { width: 500, height: 500 },
                    '1000x500': { width: 1000, height: 500 },
                }
            };

            const toggleUnit = () => {
                const newUnit = unit === 'in' ? 'mm' : 'in';
                const factor = newUnit === 'mm' ? 25.4 : (1 / 25.4);
                setUnit(newUnit);
                setConfig(prev => ({
                    ...prev,
                    width: parseFloat((prev.width * factor).toFixed(2)),
                    height: parseFloat((prev.height * factor).toFixed(2)),
                    diameter: parseFloat((prev.diameter * factor).toFixed(2)),
                    fillerDiameter: parseFloat((prev.fillerDiameter * factor).toFixed(2)),
                    margin: parseFloat((prev.margin * factor).toFixed(2)),
                    gap: parseFloat((prev.gap * factor).toFixed(2)),
                    preset: 'custom'
                }));
            };

            const handlePresetChange = (e) => {
                const val = e.target.value;
                const currentPresets = unit === 'in' ? presets.imperial : presets.metric;
                if (currentPresets[val]) {
                    setConfig(prev => ({ ...prev, preset: val, ...currentPresets[val] }));
                } else {
                    setConfig(prev => ({ ...prev, preset: 'custom' }));
                }
            };

            const calculateGridTotal = (w, h, d, gap) => {
                const effectiveD = d + gap;
                const nx = Math.floor((w - d + 0.000001) / effectiveD) + 1;
                const ny = Math.floor((h - d + 0.000001) / effectiveD) + 1;
                return Math.max(0, nx) * Math.max(0, ny);
            };

            const calculateLayout = (w, h, d, gap) => {
                const effectiveD = d + gap;
                const dy = effectiveD * (Math.sqrt(3) / 2);
                const numRows = Math.floor((h - d + 0.000001) / dy) + 1;
                if (numRows <= 0 || w < d) return { total: 0, rowData: [], dy: 0, numRows: 0 };
                let total = 0;
                const rowData = [];
                for (let i = 0; i < numRows; i++) {
                    const rowOffset = i % 2 !== 0 ? effectiveD / 2 : 0;
                    const count = Math.floor((w - rowOffset - d + 0.000001) / effectiveD) + 1;
                    if (count > 0) {
                        total += count;
                        rowData.push({ count, offset: rowOffset });
                    }
                }
                return { total, rowData, dy, numRows: rowData.length };
            };

            const getCirclePositions = (layout, width, height, diameter, margin, gap, isRotated) => {
                if (!layout) return [];
                const r = diameter / 2;
                const effectiveD = diameter + gap;
                const packingW = isRotated ? height - (margin * 2) : width - (margin * 2);
                const packingH = isRotated ? width - (margin * 2) : height - (margin * 2);

                const maxRowWidth = Math.max(...layout.rowData.map(row => (row.count - 1) * effectiveD + diameter + row.offset));
                const patternH = (layout.numRows - 1) * layout.dy + diameter;

                const startX = margin + (packingW - maxRowWidth) / 2;
                const startY = margin + (packingH - patternH) / 2;

                const circles = [];
                layout.rowData.forEach((row, rowIndex) => {
                    const py = startY + r + (rowIndex * layout.dy);
                    for (let i = 0; i < row.count; i++) {
                        const px = startX + r + (i * effectiveD) + row.offset;
                        const cx = isRotated ? py : px;
                        const cy = isRotated ? px : py;
                        circles.push({ x: cx, y: cy, r });
                    }
                });
                return circles;
            };

            useEffect(() => {
                const { width, height, diameter, margin, gap, enableFiller, fillerDiameter } = config;
                const usableW = width - (margin * 2);
                const usableH = height - (margin * 2);
                if (usableW <= 0 || usableH <= 0 || diameter <= 0) {
                    setResults({ total: 0, gridTotal: 0, layout: null, isRotated: false, largeCircles: [], fillerCircles: [], fillerTotal: 0 });
                    return;
                }
                const gridA = calculateGridTotal(usableW, usableH, diameter, gap);
                const gridB = calculateGridTotal(usableH, usableW, diameter, gap);
                const maxGrid = Math.max(gridA, gridB);
                const layoutA = calculateLayout(usableW, usableH, diameter, gap);
                const layoutB = calculateLayout(usableH, usableW, diameter, gap);

                let layout, isRotated, total;
                if (layoutA.total >= layoutB.total && layoutA.total > 0) {
                    layout = layoutA;
                    isRotated = false;
                    total = layoutA.total;
                } else if (layoutB.total > 0) {
                    layout = layoutB;
                    isRotated = true;
                    total = layoutB.total;
                } else {
                    setResults({ total: 0, gridTotal: 0, layout: null, isRotated: false, largeCircles: [], fillerCircles: [], fillerTotal: 0 });
                    return;
                }

                const largeCircles = getCirclePositions(layout, width, height, diameter, margin, gap, isRotated);

                let fillerCircles = [];
                if (enableFiller && fillerDiameter > 0) {
                    // Generate filler candidates for the whole sheet in standard orientation
                    // We assume standard orientation for filler grid for simplicity
                    const fillerLayout = calculateLayout(usableW, usableH, fillerDiameter, gap);
                    const fillerCandidates = getCirclePositions(fillerLayout, width, height, fillerDiameter, margin, gap, false);

                    const minDist = (diameter / 2) + (fillerDiameter / 2) + gap;
                    const minDistSq = minDist * minDist;

                    // Filter collisions
                    for (const filler of fillerCandidates) {
                        let collision = false;
                        for (const large of largeCircles) {
                            const dx = filler.x - large.x;
                            const dy = filler.y - large.y;
                            const distSq = dx*dx + dy*dy;
                            if (distSq < minDistSq - 0.0001) {
                                collision = true;
                                break;
                            }
                        }
                        if (!collision) {
                            fillerCircles.push(filler);
                        }
                    }
                }

                setResults({
                    total,
                    gridTotal: maxGrid,
                    layout,
                    isRotated,
                    largeCircles,
                    fillerCircles,
                    fillerTotal: fillerCircles.length
                });

            }, [config]);

            const generateSVGString = () => {
                const { width, height, margin, diameter, fillerDiameter } = config;
                const { largeCircles, fillerCircles } = results;
                if (largeCircles.length === 0) return '';

                let circles = '';
                largeCircles.forEach(c => {
                    circles += `  <circle cx="${c.x.toFixed(4)}" cy="${c.y.toFixed(4)}" r="${c.r}" fill="none" stroke="blue" stroke-width="${unit === 'in' ? 0.01 : 0.2}" />\n`;
                });

                fillerCircles.forEach(c => {
                     circles += `  <circle cx="${c.x.toFixed(4)}" cy="${c.y.toFixed(4)}" r="${c.r}" fill="none" stroke="#f59e0b" stroke-width="${unit === 'in' ? 0.01 : 0.2}" />\n`;
                });

                const unitSuffix = unit === 'in' ? 'in' : 'mm';
                return `<svg width="${width}${unitSuffix}" height="${height}${unitSuffix}" viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg">
                    <rect x="0" y="0" width="${width}" height="${height}" fill="none" stroke="#ddd" stroke-width="${unit === 'in' ? 0.02 : 0.5}" />
                    <rect x="${margin}" y="${margin}" width="${(width - margin * 2).toFixed(4)}" height="${(height - margin * 2).toFixed(4)}" fill="none" stroke="#ff0000" stroke-width="${unit === 'in' ? 0.01 : 0.2}" stroke-dasharray="${unit === 'in' ? 0.05 : 1}" opacity="0.5" />
                    ${circles}
                </svg>`;
            };

            const downloadSVG = () => {
                const svg = generateSVGString();
                const blob = new Blob([svg], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `circles_${config.width}x${config.height}${unit}.svg`;
                a.click();
            };

            const improvementCount = results.total - results.gridTotal;
            const improvementPercent = results.gridTotal > 0 ? ((improvementCount / results.gridTotal) * 100).toFixed(1) : 0;

            return (
                <div className="min-h-screen p-4 md:p-8">
                    <div className="max-w-5xl mx-auto">
                        <header className="mb-8 flex flex-col md:flex-row md:items-end justify-between gap-4">
                            <div>
                                <h1 className="text-3xl font-bold text-slate-900 flex items-center gap-2">
                                    <Icons.Layout /> Circle Packing Optimizer
                                </h1>
                                <p className="text-slate-600 font-medium tracking-tight">Maximize yield with honeycomb efficiency.</p>
                            </div>
                            <button onClick={toggleUnit} className="flex items-center gap-2 bg-white border border-slate-300 px-4 py-2 rounded-lg font-bold text-slate-700 hover:bg-slate-50 transition-all shadow-sm active:scale-95">
                                <span className="text-blue-600"><Icons.Refresh /></span> Switch to {unit === 'in' ? 'Metric (mm)' : 'Imperial (in)'}
                            </button>
                        </header>

                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 h-fit">
                                <div className="flex items-center gap-2 mb-4 text-slate-800 font-semibold border-b pb-2">
                                    <Icons.Settings /> Parameters ({unit})
                                </div>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">Material Preset</label>
                                        <select className="w-full p-2 bg-slate-50 border border-slate-300 rounded-md outline-blue-500" value={config.preset} onChange={handlePresetChange}>
                                            <option value="custom">Custom Size</option>
                                            {unit === 'in' ? (
                                                <React.Fragment>
                                                    <option value="12x24">12" x 24" Material</option>
                                                    <option value="12x12">12" x 12" Material</option>
                                                    <option value="8.5x11">Letter (8.5 x 11)</option>
                                                    <option value="11x17">Ledger (11 x 17)</option>
                                                </React.Fragment>
                                            ) : (
                                                <React.Fragment>
                                                    <option value="A4">A4 (297 x 210 mm)</option>
                                                    <option value="A3">A3 (420 x 297 mm)</option>
                                                    <option value="500x500">500 x 500 mm</option>
                                                    <option value="1000x500">1000 x 500 mm</option>
                                                </React.Fragment>
                                            )}
                                        </select>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium text-slate-700 mb-1">Width</label>
                                            <input type="number" step="0.1" className="w-full p-2 bg-slate-50 border border-slate-300 rounded-md" value={config.width} onChange={(e) => setConfig({...config, width: parseFloat(e.target.value) || 0, preset: 'custom'})} />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-slate-700 mb-1">Height</label>
                                            <input type="number" step="0.1" className="w-full p-2 bg-slate-50 border border-slate-300 rounded-md" value={config.height} onChange={(e) => setConfig({...config, height: parseFloat(e.target.value) || 0, preset: 'custom'})} />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">Circle Diameter</label>
                                        <input type="number" step="0.01" className="w-full p-2 bg-slate-50 border border-slate-300 rounded-md font-mono text-blue-600 font-bold" value={config.diameter} onChange={(e) => setConfig({...config, diameter: parseFloat(e.target.value) || 0})} />
                                    </div>

                                    <div className="border-t pt-4">
                                        <div className="flex items-center gap-2 mb-2">
                                            <input type="checkbox" id="enableFiller" checked={config.enableFiller} onChange={(e) => setConfig({...config, enableFiller: e.target.checked})} className="rounded text-blue-600 focus:ring-blue-500" />
                                            <label htmlFor="enableFiller" className="text-sm font-medium text-slate-700 cursor-pointer">Add Filler Circles</label>
                                        </div>
                                        {config.enableFiller && (
                                            <div>
                                                <label className="block text-sm font-medium text-slate-700 mb-1">Filler Diameter</label>
                                                <input type="number" step="0.01" className="w-full p-2 bg-slate-50 border border-slate-300 rounded-md font-mono text-amber-500 font-bold" value={config.fillerDiameter} onChange={(e) => setConfig({...config, fillerDiameter: parseFloat(e.target.value) || 0})} />
                                            </div>
                                        )}
                                    </div>

                                    <div className="grid grid-cols-2 gap-4 border-t pt-4">
                                        <div>
                                            <label className="block text-sm font-medium text-slate-700 mb-1">Margins</label>
                                            <input type="number" step="0.01" className="w-full p-2 bg-slate-50 border border-slate-300 rounded-md" value={config.margin} onChange={(e) => setConfig({...config, margin: parseFloat(e.target.value) || 0})} />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-slate-700 mb-1">Min Gap</label>
                                            <input type="number" step="0.001" className="w-full p-2 bg-slate-50 border border-slate-300 rounded-md" value={config.gap} onChange={(e) => setConfig({...config, gap: parseFloat(e.target.value) || 0})} />
                                        </div>
                                    </div>
                                    <button onClick={downloadSVG} disabled={results.total === 0} className="w-full mt-4 flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-300 text-white font-bold py-3 px-4 rounded-lg transition-colors shadow-md">
                                        <Icons.Download /> Download SVG
                                    </button>
                                </div>
                            </div>

                            <div className="lg:col-span-2 space-y-6">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="bg-blue-600 text-white p-6 rounded-xl shadow-lg flex justify-between items-center">
                                        <div>
                                            <span className="text-blue-100 text-xs uppercase tracking-widest font-black">Optimized Yield</span>
                                            <div className="text-5xl font-black leading-none mt-1">{results.total}</div>
                                            <div className="mt-2 text-xs text-blue-200 font-medium italic">Hexagonal Packing</div>
                                        </div>
                                        <div className="bg-blue-500 rounded-lg p-3 text-center">
                                            <div className="opacity-80 text-[10px] font-bold">ROWS</div>
                                            <div className="font-bold text-sm uppercase">{results.isRotated ? 'Vertical' : 'Horizontal'}</div>
                                        </div>
                                    </div>

                                    {config.enableFiller ? (
                                        <div className="bg-amber-500 text-white p-6 rounded-xl shadow-lg flex justify-between items-center">
                                            <div>
                                                <span className="text-amber-100 text-xs uppercase tracking-widest font-black">Filler Yield</span>
                                                <div className="text-5xl font-black leading-none mt-1">{results.fillerTotal}</div>
                                                <div className="mt-2 text-xs text-amber-200 font-medium italic">Diameter: {config.fillerDiameter} {unit}</div>
                                            </div>
                                            <div className="bg-amber-600 rounded-lg p-3 text-center">
                                                <Icons.Layers />
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="bg-white p-6 rounded-xl border-2 border-slate-200 shadow-sm flex justify-between items-center">
                                            <div className="space-y-1">
                                                <span className="text-slate-500 text-xs uppercase tracking-widest font-black">Efficiency Gain</span>
                                                <div className="flex items-baseline gap-2">
                                                    <span className="text-2xl font-bold text-slate-400 line-through decoration-slate-300">{results.gridTotal}</span>
                                                    <span className="text-3xl font-black text-green-600">+{improvementCount}</span>
                                                </div>
                                                <div className="flex items-center gap-1 text-green-600 font-bold text-sm">
                                                    <Icons.TrendingUp /> {improvementPercent}% Increase
                                                </div>
                                            </div>
                                            <div className="bg-slate-50 border border-slate-100 rounded-lg p-3 text-right">
                                                <div className="text-slate-400 text-[10px] font-bold">STANDARD GRID</div>
                                                <div className="font-bold text-slate-600 text-sm">{results.gridTotal} Units</div>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 min-h-[400px] flex items-center justify-center overflow-hidden relative">
                                    <div className="absolute top-4 left-4 flex gap-2">
                                        <span className="bg-blue-100 text-blue-700 px-2 py-1 rounded text-[10px] font-bold uppercase">SVG Preview</span>
                                    </div>
                                    {results.total > 0 ? (
                                        <div className="w-full h-full flex items-center justify-center p-4 svg-preview">
                                            <div className="relative bg-white shadow-inner border border-slate-100" dangerouslySetInnerHTML={{ __html: generateSVGString() }} />
                                        </div>
                                    ) : (
                                        <div className="text-slate-400 flex flex-col items-center gap-2">
                                            <Icons.Info />
                                            <p>Adjust parameters to generate a layout.</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
